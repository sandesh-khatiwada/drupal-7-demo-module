<?php

/**
 * Implements hook_menu().
 */
function demo_menu() {

  $items = array();

  // List page
  $items['demo-data'] = array(
    'title' => t('Demo Data Table'),
    'page callback' => 'demo_data_page',
    'access arguments' => array('access content'),
  );

  // Add form
  $items['demo-data/add'] = array(
    'title' => t('Add Demo Item'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('demo_item_form'),
    'access arguments' => array('access content'),
  );

  // Edit form
  $items['demo-data/%/edit'] = array(
    'title' => t('Edit Demo Item'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('demo_item_form', 1),
    'access arguments' => array('access content'),
  );

  // Delete form
  $items['demo-data/%/delete'] = array(
    'title' => t('Delete Demo Item'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('demo_item_delete_form', 1),
    'access arguments' => array('access content'),
  );

  return $items;
}


/**
 * Implements hook_theme().
 */

// register hook theme 
function demo_theme($existing, $type, $theme, $path) {

  return array(
    'demo_data_table' => array(
      'variables' => array(
        'header' => array(),
        'rows'   => array(),
      ),
      'template' => 'demo',
    ),
  );
}


/**
 * List page.
 */
function demo_data_page() {

  $result = db_select('demo_items', 'd')
    ->fields('d')
    ->orderBy('weight', 'ASC')
    ->orderBy('title', 'ASC')
    ->execute();

  $rows = array();

  foreach ($result as $row) {

    $operations =
      l(t('Edit'), 'demo-data/' . $row->id . '/edit') . ' | ' .
      l(t('Delete'), 'demo-data/' . $row->id . '/delete');

    $rows[] = array(
      'id' => $row->id,
      'title' => $row->title,
      'description' => $row->description,
      'weight' => $row->weight,
      'created' => $row->created,
      'operations' => $operations,
    );
  }

  $header = array(
    t('ID'),
    t('Title'),
    t('Description'),
    t('Weight'),
    t('Created'),
    t('Operations'),
  );

  return theme('demo_data_table', array(
    'header' => $header,
    'rows' => $rows,
  ));
}


/**
 * Add/Edit form.
 */
function demo_item_form($form, &$form_state, $id = NULL) {

  $item = NULL;

  if ($id) {
    $item = db_select('demo_items', 'd')
      ->fields('d')
      ->condition('id', $id)
      ->execute()
      ->fetchObject();
  }

  $form['id'] = array(
    '#type' => 'hidden',
    '#value' => $id,
  );

  $form['title'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#required' => TRUE,
    '#default_value' => $item ? $item->title : '',
    '#maxlength' => 255,
  );

  $form['description'] = array(
    '#type' => 'textarea',
    '#title' => t('Description'),
    '#default_value' => $item ? $item->description : '',
  );


  $form['weight'] = array(
    '#type' => 'textfield',
    '#title' => t('Weight'),
    '#required' => TRUE,
    '#default_value' => $item ? $item->weight : 0,
    '#size' => 10,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => $id ? t('Update') : t('Add'),
  );

  return $form;
}


/**
 * Validation.
 */
function demo_item_form_validate($form, &$form_state) {

  if (strlen(trim($form_state['values']['title'])) < 3) {
    form_set_error('title', t('Title must be at least 3 characters long.'));
  }


  if (!isset($form_state['values']['weight']) || !is_numeric($form_state['values']['weight'])) {
    form_set_error('weight', t('Weight must be numeric.'));
  }
}


/**
 * Submit handler.
 */
function demo_item_form_submit($form, &$form_state) {

  $values = $form_state['values'];

  if (!empty($values['id'])) {

    db_update('demo_items')
      ->fields(array(
        'title' => $values['title'],
        'description' => $values['description'],
        'weight' => $values['weight'],
      ))
      ->condition('id', $values['id'])
      ->execute();

    drupal_set_message(t('Item updated successfully.'));
  }
  else {

    db_insert('demo_items')
      ->fields(array(
        'title' => $values['title'],
        'description' => $values['description'],
        'weight' => $values['weight'],
        'created' => REQUEST_TIME,
      ))
      ->execute();

    drupal_set_message(t('Item added successfully.'));
  }

  $form_state['redirect'] = 'demo-data';
}


/**
 * Delete confirmation form.
 */
function demo_item_delete_form($form, &$form_state, $id) {

  $form['id'] = array(
    '#type' => 'hidden',
    '#value' => $id,
  );

  return confirm_form(
    $form,
    t('Are you sure you want to delete this item?'),
    'demo-data',
    t('This action cannot be undone.'),
    t('Delete'),
    t('Cancel')
  );
}


/**
 * Delete submit.
 */
function demo_item_delete_form_submit($form, &$form_state) {

  db_delete('demo_items')
    ->condition('id', $form_state['values']['id'])
    ->execute();

  drupal_set_message(t('Item deleted successfully.'));
  $form_state['redirect'] = 'demo-data';
}
